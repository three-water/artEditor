!function(){function t(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}$.fn.extend({_opt:{placeholder:"请输入文章正文内容",validHtml:[],limitSize:3,showServer:!1,formInputId:"artTarget",showUploadBtn:!0},artEditor:function(t){var e=this,i={"-webkit-user-select":"text","user-select":"text","overflow-y":"auto","text-break":"brak-all",outline:"none",cursor:"text"};$(this).css(i).attr("contenteditable",!0),e._opt=$.extend(e._opt,t),this.initArtDom();try{$(e._opt.imgTar).on("change",function(t){var i=t.target.files,a=i[0];if(Math.ceil(a.size/1024/1024)>e._opt.limitSize)return void console.error("文件太大");var n=new FileReader;n.readAsDataURL(a),n.onload=function(t){var i=t.target.result,n=new Image;n.src=t.target.result,e._opt.compressSize&&Math.ceil(a.size/1024/1024)>e._opt.compressSize&&setTimeout(function(){i=e.compressHandler(n)},10)},e._opt.showServer&&e.upload(i)}),e.placeholderHandler(),e.pasteHandler()}catch(t){console.log(t)}return e._opt.formInputId&&$("#"+e._opt.formInputId)[0]&&$(e).on("input",function(){var t=e.getValue();$("#"+e._opt.formInputId).val(t),window.native&&window.native.onTextChange&&window.native.onTextChange(t)}),$(this).on("input click",function(){$(this);return setTimeout(function(){var t=window.getSelection?window.getSelection():document.selection;e.range=t.createRange?t.createRange():t.getRangeAt(0)},10),!1}),!/firefox/.test(navigator.userAgent.toLowerCase())&&this._opt.breaks&&$(this).keydown(function(t){if(13===t.keyCode)return document.execCommand("insertHTML",!1,"<br/><br/>"),!1}),this},initArtDom:function(){var t=this;$(this).addClass("art-editor"),t._opt.showUploadBtn&&($(t).after('<div class="art-upload"><div class="upload-button"><span class="upload"><i class="upload-img"></i>插入图片</span><input class="input-file" id="imageUpload" type="file" name="fileInput" accept="image/*" style="position:absolute;left:0;opacity:0;width:100%;"></div></div>'),t._opt.imgTar=$(t).parent().find("#imageUpload")[0],$(this).after('<input type="hidden" id="artTarget">'))},compressHandler:function(t){var e,i=document.createElement("canvas"),a=i.getContext("2d"),n=document.createElement("canvas"),r=n.getContext("2d"),o=(t.src.length,t.width),s=t.height;(e=o*s/4e6)>1?(e=Math.sqrt(e),o/=e,s/=e):e=1,i.width=o,i.height=s,a.fillStyle="#fff",a.fillRect(0,0,i.width,i.height);var l;if((l=o*s/1e6)>1){l=~~(Math.sqrt(l)+1);var d=~~(o/l),p=~~(s/l);n.width=d,n.height=p;for(var c=0;c<l;c++)for(var u=0;u<l;u++)r.drawImage(t,c*d*e,u*p*e,d*e,p*e,0,0,d,p),a.drawImage(n,c*d,u*p,d,p)}else a.drawImage(t,0,0,o,s);var g=i.toDataURL("image/jpeg",.1);return n.width=n.height=i.width=i.height=0,g},readFile:function(t){return new Promise(function(e,i){var a=new FileReader;a.readAsDataURL(t),a.onload=function(t){e(this.result)}})},preUpload:function(e){var i=t(),a=this;a._opt.uploadField||"file";return this.insertImage('<div class="art-img-box loading" guid="'+i+'"><span class="progress"></span><img src="'+e+'" /></div>'),i},updateProgress:function(t,e){this.find('div[guid="'+t+'"] .progress').width(e)},uploadSuccess:function(t,e){var i=this,a=new Image,n=this.find('div[guid="'+t+'"]');a.src=e,a.onload=function(){n.removeClass("loading").removeAttr("guid").empty().append(a),$(i).trigger("input"),$(i).trigger("art-uploading")}},upload:function(t){var e=this,i=e._opt.uploadField||"file";if(t.length>0)for(var a=0;a<t.length;a++)!function(a){e.readFile(t[a]).then(function(n){var r=e.preUpload(n),o=new FormData;o.append(i,t[a]);var s=e._opt.data;for(var l in s)o.append(l,s[l]);$(e).trigger("art-uploading"),$.ajax({url:e._opt.uploadUrl,type:"post",data:o,cache:!1,contentType:!1,processData:!1,xhr:function(){var t=$.ajaxSettings.xhr();return e.updateProgress&&t.upload&&t.upload.addEventListener("progress",function(t){e.updateProgress(r,parseInt(t.loaded/t.total*100)+"%")},!1),t}}).done(function(t){e._opt.imgTar.value="";e._opt.uploadSuccess&&e._opt.uploadSuccess(t),2e3===t.status&&e.uploadSuccess(r,t.data.url)}).fail(function(t){e._opt.uploadError(t.status,t)})})}(a)},insertImage:function(t){/<img\s/.test(t)||(t='<img src="'+t+'" style="max-width:100%;" />'),$(this).focus();var e,i=window.getSelection?window.getSelection():document.selection;if(this.range?(e=this.range,this.range=null):e=i.createRange?i.createRange():i.getRangeAt(0),window.getSelection){e.collapse(!1);for(var a=e.createContextualFragment(t),n=a.lastChild;n&&"br"==n.nodeName.toLowerCase()&&n.previousSibling&&"br"==n.previousSibling.nodeName.toLowerCase();){var r=n;n=n.previousSibling,a.removeChild(r)}e.insertNode(e.createContextualFragment("<br/>")),e.insertNode(a),n&&(e.setEndAfter(n),e.setStartAfter(n)),i.removeAllRanges(),i.addRange(e)}else e.pasteHTML(t),e.collapse(!1),e.select();this._opt.formInputId&&$("#"+this._opt.formInputId)[0]&&$("#"+this._opt.formInputId).val(this.getValue()),$(this).trigger("input")},pasteHandler:function(){var t=this;$(this).on("paste",function(e){var i=$(this).html();valiHTML=t._opt.validHtml,i=i.replace(/_moz_dirty=""/gi,"").replace(/\[/g,"[[-").replace(/\]/g,"-]]").replace(/<\/ ?tr[^>]*>/gi,"[br]").replace(/<\/ ?td[^>]*>/gi,"&nbsp;&nbsp;").replace(/<(ul|dl|ol)[^>]*>/gi,"[br]").replace(/<(li|dd)[^>]*>/gi,"[br]").replace(/<p [^>]*>/gi,"[br]").replace(new RegExp("<(/?(?:"+valiHTML.join("|")+")[^>]*)>","gi"),"[$1]").replace(new RegExp('<span([^>]*class="?at"?[^>]*)>',"gi"),"[span$1]").replace(/<[^>]*>/g,"").replace(/\[\[\-/g,"[").replace(/\-\]\]/g,"]").replace(new RegExp("\\[(/?(?:"+valiHTML.join("|")+"|img|span)[^\\]]*)\\]","gi"),"<$1>"),/firefox/.test(navigator.userAgent.toLowerCase())||(i=i.replace(/\r?\n/gi,"<br>")),$(this).html(i)})},placeholderHandler:function(){var t=this,e=/<img\s*([\w]+=(\"|\')([^\"\']*)(\"|\')\s*)*\/?>/;$(this).on("focus",function(){$.trim($(this).text())===t._opt.placeholder&&$(this).html("")}).on("blur",function(){$.trim($(this).text())||e.test($(this).html())||$(this).html('<div class="placeholder" style="pointer-events: none;">'+t._opt.placeholder+"</div>")}),$.trim($(this).text())||e.test($(this).html())||$(this).html('<div class="placeholder" style="pointer-events: none;">'+t._opt.placeholder+"</div>")},isUploading:function(){return $(this).find(".art-img-box.loading").length>0},getValue:function(){return $(this).html()},setValue:function(t){$(this).html(t)}})}();