$.fn.extend({_opt:{placeholader:"请输入文章正文内容",validHtml:[],limitSize:3,showServer:!1,formInputId:"artTarget",showUploadBtn:!0},artEditor:function(e){var t=this,a={"-webkit-user-select":"text","user-select":"text","overflow-y":"auto","text-break":"brak-all",outline:"none",cursor:"text"};$(this).css(a).attr("contenteditable",!0),t._opt=$.extend(t._opt,e),this.initArtDom();try{$(t._opt.imgTar).on("change",function(e){var a=e.target.files,o=a[0];if(Math.ceil(o.size/1024/1024)>t._opt.limitSize)return void console.error("文件太大");var i=new FileReader;i.readAsDataURL(o),i.onload=function(e){var a=e.target.result,i=new Image;i.src=e.target.result,t._opt.compressSize&&Math.ceil(o.size/1024/1024)>t._opt.compressSize&&setTimeout(function(){a=t.compressHandler(i)},10)},t._opt.showServer&&t.upload(a)}),t.placeholderHandler(),t.pasteHandler()}catch(e){console.log(e)}t._opt.formInputId&&$("#"+t._opt.formInputId)[0]&&$(t).on("input",function(){$("#"+t._opt.formInputId).val(t.getValue())}),$(this).on("input click",function(){return setTimeout(function(){var e=window.getSelection?window.getSelection():document.selection;t.range=e.createRange?e.createRange():e.getRangeAt(0),console.log(t.range)},10),!1}),!/firefox/.test(navigator.userAgent.toLowerCase())&&this._opt.breaks&&$(this).keydown(function(e){if(13===e.keyCode)return document.execCommand("insertHTML",!1,"<br/><br/>"),!1})},initArtDom:function(){var e=this;$(this).addClass("art-editor"),e._opt.showUploadBtn&&($(e).after('<div class="art-upload"><div class="upload-button"><span class="upload"><i class="upload-img"></i>插入图片</span><input class="input-file" id="imageUpload" type="file" name="fileInput" accept="image/*" style="position:absolute;left:0;opacity:0;width:100%;"></div></div>'),$(this).after('<input type="hidden" id="artTarget">'))},compressHandler:function(e){var t,a=document.createElement("canvas"),o=a.getContext("2d"),i=document.createElement("canvas"),r=i.getContext("2d"),n=(e.src.length,e.width),l=e.height;(t=n*l/4e6)>1?(t=Math.sqrt(t),n/=t,l/=t):t=1,a.width=n,a.height=l,o.fillStyle="#fff",o.fillRect(0,0,a.width,a.height);var s;if((s=n*l/1e6)>1){s=~~(Math.sqrt(s)+1);var c=~~(n/s),p=~~(l/s);i.width=c,i.height=p;for(var d=0;d<s;d++)for(var u=0;u<s;u++)r.drawImage(e,d*c*t,u*p*t,c*t,p*t,0,0,c,p),o.drawImage(i,d*c,u*p,c,p)}else o.drawImage(e,0,0,n,l);var h=a.toDataURL("image/jpeg",.1);return i.width=i.height=a.width=a.height=0,h},upload:function(e){var t=this,a=t._opt.uploadField||"file",o=new FormData;o.append(a,e[0]);var i=t._opt.data;for(var r in i)o.append(r,i[r]);$.ajax({url:t._opt.uploadUrl,type:"post",data:o,cache:!1,contentType:!1,processData:!1}).then(function(e){t._opt.imgTar.value="";var a="";if(t._opt.uploadSuccess&&t._opt.uploadSuccess(e),2e3===e.status&&(a=e.data.url),a){var o='<img src="'+a+'" style="max-width:100%;" />';t.insertImage(o)}else console.log("地址为空啊!大兄弟",a)},function(e){t._opt.uploadError(e.status,e)})},insertImage:function(e){$(this).focus();var t,a=window.getSelection?window.getSelection():document.selection;if(this.range?(t=this.range,this.range=null):t=a.createRange?a.createRange():a.getRangeAt(0),window.getSelection){t.collapse(!1);for(var o=t.createContextualFragment(e),i=o.lastChild;i&&"br"==i.nodeName.toLowerCase()&&i.previousSibling&&"br"==i.previousSibling.nodeName.toLowerCase();){var r=i;i=i.previousSibling,o.removeChild(r)}t.insertNode(t.createContextualFragment("<br/>")),t.insertNode(o),i&&(t.setEndAfter(i),t.setStartAfter(i)),a.removeAllRanges(),a.addRange(t)}else t.pasteHTML(e),t.collapse(!1),t.select();this._opt.formInputId&&$("#"+this._opt.formInputId)[0]&&$("#"+this._opt.formInputId).val(this.getValue())},pasteHandler:function(){var e=this;$(this).on("paste",function(t){console.log(t.clipboardData.items);var a=$(this).html();console.log(a),valiHTML=e._opt.validHtml,a=a.replace(/_moz_dirty=""/gi,"").replace(/\[/g,"[[-").replace(/\]/g,"-]]").replace(/<\/ ?tr[^>]*>/gi,"[br]").replace(/<\/ ?td[^>]*>/gi,"&nbsp;&nbsp;").replace(/<(ul|dl|ol)[^>]*>/gi,"[br]").replace(/<(li|dd)[^>]*>/gi,"[br]").replace(/<p [^>]*>/gi,"[br]").replace(new RegExp("<(/?(?:"+valiHTML.join("|")+")[^>]*)>","gi"),"[$1]").replace(new RegExp('<span([^>]*class="?at"?[^>]*)>',"gi"),"[span$1]").replace(/<[^>]*>/g,"").replace(/\[\[\-/g,"[").replace(/\-\]\]/g,"]").replace(new RegExp("\\[(/?(?:"+valiHTML.join("|")+"|img|span)[^\\]]*)\\]","gi"),"<$1>"),/firefox/.test(navigator.userAgent.toLowerCase())||(a=a.replace(/\r?\n/gi,"<br>")),$(this).html(a)})},placeholderHandler:function(){var e=this,t=/<img\s*([\w]+=(\"|\')([^\"\']*)(\"|\')\s*)*\/?>/;$(this).on("focus",function(){$.trim($(this).text())===e._opt.placeholader&&$(this).html("")}).on("blur",function(){$.trim($(this).text())||t.test($(this).html())||$(this).html('<div class="placeholader" style="pointer-events: none;">'+e._opt.placeholader+"</div>")}),$.trim($(this).text())||t.test($(this).html())||$(this).html('<div class="placeholader" style="pointer-events: none;">'+e._opt.placeholader+"</div>")},getValue:function(){return $(this).html()},setValue:function(e){$(this).html(e)}});